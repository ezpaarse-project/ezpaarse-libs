{"version":3,"sources":["pipeline.js"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA,IAAM,CAAC,GAAiB,OAAO,CAAC,QAAQ,CAAC,CAAC;AAC1C,IAAM,MAAM,GAAY,OAAO,CAAC,QAAQ,CAAC,CAAC;AAC1C,IAAM,KAAK,GAAa,OAAO,CAAC,SAAS,CAAC,CAAC;AAC3C,IAAM,IAAI,GAAc,OAAO,CAAC,IAAI,CAAC,CAAC;;eACd,OAAO,CAAC,SAAS,CAAC;;IAAlC,OAAO,YAAP,OAAO;;gBACS,OAAO,CAAC,MAAM,CAAC;;IAA/B,OAAO,aAAP,OAAO;;AACf,IAAM,IAAI,GAAc,OAAO,CAAC,MAAM,CAAC,CAAC;AACxC,IAAM,OAAO,GAAW,OAAO,CAAC,SAAS,CAAC,CAAC;AAC3C,IAAM,cAAc,GAAI,OAAO,CAAC,yCAAyC,CAAC,CAAC;AAC3E,IAAM,GAAG,GAAe,OAAO,CAAC,KAAK,CAAC,CAAC;AACvC,IAAM,KAAK,GAAa,OAAO,CAAC,uBAAuB,CAAC,CAAC;;;;;IAKnD,QAAQ;AAED,WAFP,QAAQ,CAEA,OAAO,EAAE;0BAFjB,QAAQ;;AAGV,qCAHE,QAAQ,6CAGF;AACR,QAAI,CAAC,QAAQ,GAAG,OAAO,CAAC;;;;;;AACxB,6CAAoB,QAAQ,CAAC,QAAQ;YAA5B,OAAO;;AACd,YAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;OAAA;;;;;;;;;;;;;;;GACtB;;YAPG,QAAQ;;eAAR,QAAQ;;WASA,gBAAC,KAAK,EAAE,IAAI;UAChB,OAAO,EACP,OAAO,EAKL,QAAQ;;;;AANV,mBAAO,GAAK,IAAI,KAAK,CAAC,OAAO,CAAC,KAAK,EAAE,IAAI,CAAC;AAC1C,mBAAO,GAAK,IAAI,CAAC,QAAQ;;AAC/B,mBAAO,CAAC,IAAI,CAAC,SAAS,EAAE,OAAO,CAAC,CAAC;;;;mBAIL,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC;;;AAA9C,oBAAQ;;AACd,oBAAQ,CAAC,IAAI,GAAO,MAAA,IAAI,CAAC,GAAG,EAAE,CAAC;AAC/B,oBAAQ,CAAC,OAAO,GAAI,OAAO,CAAC;AAC5B,mBAAO,CAAC,IAAI,CAAC,UAAU,EAAE,OAAO,EAAE,QAAQ,CAAC,CAAC;gDACrC,QAAQ;;;;;;AAGf,mBAAO,CAAC,MAAM,CAAC,gBAAgB,EAAE,eAAM,KAAK,CAAC,CAAC;kBACxC,IAAI,SAAS,CAAC,eAAM,OAAO,CAAC;;;;;;;KAErC;;;WAEiB,sBAAC,OAAO;UAClB,OAAO,EACP,eAAe,EACf,gBAAgB,EAElB,QAAQ,uFACH,cAAc,uFAKd,eAAe;;;;;AAVlB,mBAAO,GAAa,IAAI,CAAC,QAAQ;AACjC,2BAAe,GAAK,IAAI,CAAC,MAAM,CAAC,UAAA,EAAE;qBAAI,EAAE,CAAC,MAAM,KAAK,CAAC;aAAA,CAAC,CAAC,MAAM,CAAC,QAAQ,CAAC,eAAe,CAAC;AACvF,4BAAgB,GAAI,IAAI,CAAC,MAAM,CAAC,UAAA,EAAE;qBAAI,EAAE,CAAC,MAAM,KAAK,CAAC;aAAA,CAAC;AAExD,oBAAQ;;;;;2CACe,eAAe;;;;;;;;AAAjC,0BAAc;;mBACJ,cAAc,CAAC,OAAO,EAAE,OAAO,CAAC;;;AAAjD,oBAAQ;;iBACJ,QAAQ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;2CAGc,gBAAgB;;;;;;;;AAAnC,2BAAe;;mBACL,eAAe,CAAC,OAAO,EAAE,OAAO,EAAE,QAAQ,CAAC;;;AAA5D,oBAAQ;;AACR,kBAAM,CAAC,QAAQ,EAAE,yCAAyC,CAAC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;gDAEvD,QAAQ;;;;;;;KAChB;;;;;;;;WAOS,oBAAC,OAAO,EAAE;AAClB,YAAM,CAAC,OAAO,CAAC,IAAI,EAAE,4BAA4B,CAAC,CAAC;AACnD,YAAM,CAAC,OAAO,CAAC,MAAM,KAAK,CAAC,IAAI,OAAO,CAAC,MAAM,KAAK,CAAC,EAAE,6EAA6E,CAAC,CAAC;AACpI,UAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;KACpB;;;;;;WAIgB,oBAAC,OAAO,EAAE;AACzB,YAAM,CAAC,OAAO,CAAC,IAAI,EAAE,4BAA4B,CAAC,CAAC;AACnD,YAAM,CAAC,OAAO,CAAC,MAAM,KAAK,CAAC,IAAI,OAAO,CAAC,MAAM,KAAK,CAAC,EAAE,8EAA8E,CAAC,CAAC;AACrI,UAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;KAC7B;;;;;;;;;;WASkB,sBAAC,OAAO,EAAE,OAAO,EAAE;AACpC,UAAI,OAAO,CAAC,QAAQ;;;AAGlB,eAAO,CAAC,GAAG,GAAG,cAAc,CAAC,kBAAkB,CAAC,OAAO,CAAC,QAAQ,EAAE,OAAO,CAAC,GAAG,CAAC,CAAC,KAE/E,OAAO,CAAC,GAAG,GAAG,KAAK,CAAC,WAAW,CAAC,OAAO,CAAC,IAAI,IAAI,kBAAkB,EAAE,OAAO,CAAC,GAAG,CAAC,CAAC;KACpF;;;;;;;;;;WASkB,sBAAC,OAAO,EAAE,OAAO,EAAE;AACpC,UAAI,OAAO,CAAC,OAAO,EACjB,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,OAAO,EAAE,UAAC,KAAK,EAAE,IAAI,EAAI;AACtC,eAAO,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,EAAE,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC;OACrD,CAAC,CAAC;AACL,UAAI,CAAC,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,YAAY,CAAC,EACpC,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,YAAY,EAAE,OAAO,CAAC,SAAS,CAAC,CAAC;;;;uBAGtC,GAAG,CAAC,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC;;UAA/B,IAAI,cAAJ,IAAI;;AACZ,aAAO,CAAC,OAAO,CAAC,GAAG,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;;;AAGlC,UAAM,YAAY,GAAG,EAAE,IAAI,EAAJ,IAAI,EAAE,QAAQ,EAAE,IAAI,EAAE,QAAQ,EAAE,IAAI,EAAE,CAAC;AAC9D,aAAO,CAAC,IAAI,CAAC,cAAc,EAAE,YAAY,CAAC,CAAC;UACnC,QAAQ,GAAe,YAAY,CAAnC,QAAQ;UAAE,QAAQ,GAAK,YAAY,CAAzB,QAAQ;;AAC1B,UAAI,QAAQ,IAAI,QAAQ,EAAE;AACxB,eAAO,CAAC,GAAG,wBAAsB,QAAQ,SAAI,QAAQ,CAAG,CAAC;AACzD,YAAM,MAAM,GAAG,IAAI,MAAM,MAAI,QAAQ,SAAI,QAAQ,CAAG,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;AACxE,eAAO,CAAC,OAAO,CAAC,GAAG,CAAC,eAAe,aAAY,MAAM,CAAG,CAAC;OAC1D;KACF;;;;;;;;WAO2B,yBAAC,OAAO,EAAE,OAAO;UACnC,GAAG,eACH,QAAQ,EAAE,QAAQ,EAAE,QAAQ,EAU5B,QAAQ,EACR,MAAM,EAEJ,MAAM;;;;;;;AAdR,eAAG,GAAK,OAAO,CAAf,GAAG;0BAC8B,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC;AAA/C,oBAAQ,eAAR,QAAQ;AAAE,oBAAQ,eAAR,QAAQ;AAAE,oBAAQ,eAAR,QAAQ;;kBAEhC,QAAQ,KAAK,OAAO,CAAA;;;;;kBAKlB,OAAO,CAAC,MAAM,KAAK,KAAK,CAAA;;;;;gDACnB,IAAI,KAAK,CAAC,QAAQ,CAAC,EAAE,EAAE,EAAE,GAAG,EAAH,GAAG,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;;;AAE/C,oBAAQ,GAAG,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC,QAAQ,CAAC,CAAC;AAC9C,kBAAM,GAAK,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC;;iBACtC,MAAM;;;;;AACF,kBAAM,GAAG,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC;gDACvC,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,EAAE,EAAE,GAAG,EAAH,GAAG,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;;;gDAEhD,IAAI,KAAK,CAAC,QAAQ,CAAC,EAAE,EAAE,EAAE,GAAG,EAAH,GAAG,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;;;;;;;;;kBAK7C,OAAO,EACT,YAAY,EAIZ,MAAM,EACN,WAAW;;;;AANT,2BAAO,GAAO,OAAO,CAArB,OAAO;AACT,gCAAY,GAAI,OAAO,CAAC,SAAS,CAAC,QAAQ,EAAE,QAAQ,CAAC;;AAC3D,wBAAI,YAAY,EACd,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC,QAAQ,EAAE,YAAY,CAAC,CAAC;;yBAE7B,YAAY,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC;;;;;qCAAG,IAAI;;;;;;2BAAS,OAAO,CAAC,QAAQ,EAAE;;;;;;AAAjF,0BAAM;AACN,+BAAW,GAAG,IAAI,OAAO,CAAC;AAC9B,4BAAM,EAAU,OAAO,CAAC,MAAM;AAC9B,yBAAG,EAAa,OAAO,CAAC,GAAG;AAC3B,6BAAO,EAAS,OAAO,CAAC,OAAO,CAAC,QAAQ,EAAE;AAC1C,2BAAK,EAAW,OAAO,CAAC,KAAK;AAC7B,0BAAI,EAAY,MAAM;AACtB,yBAAG,EAAa,KAAK;AACrB,oCAAc,EAAE,KAAK;AACrB,+BAAS,EAAO,OAAO,CAAC,SAAS;AACjC,kCAAY,EAAI,OAAO,CAAC,YAAY,IAAI,CAAC;qBAC1C,CAAC;;2BACW,UAAI,OAAO,CAAC,UAAS,OAAO,EAAE,MAAM,EAAE;AACjD,iCAAW,CACR,EAAE,CAAC,UAAU,EAAE,UAAC,QAAQ,EAAI;;;;AAI3B,4BAAM,cAAc,GAAG,CAAC,CAAC,MAAM,CAAC,QAAQ,CAAC,OAAO,EAAE,UAAC,OAAO,EAAE,KAAK,EAAE,IAAI,EAAI;AACzE,8BAAI,OAAO,CAAC,KAAK,CAAC;;;;;;AAChB,sEAAiB,KAAK;oCAAb,IAAI;;AACX,uCAAO,CAAC,IAAI,CAAC,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;+BAAA;;;;;;;;;;;;;;;iCAE7B,OAAO,CAAC,IAAI,CAAC,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC,CAAC;AAC9B,iCAAO,OAAO,CAAC;yBAChB,EAAE,EAAE,CAAC,CAAC;;AAEP,+BAAO,CAAC,IAAI,KAAK,CAAC,QAAQ,CAAC,QAAQ,EAAE;AACnC,6BAAG,EAAS,OAAO,CAAC,GAAG;AACvB,gCAAM,EAAM,QAAQ,CAAC,UAAU;AAC/B,iCAAO,EAAK,IAAI,OAAO,CAAC,cAAc,CAAC;yBACxC,CAAC,CAAC,CAAC;uBACL,CAAC,CACD,EAAE,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC;qBACxB,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;KAGL;;;;;;WAKmB,uBAAC,OAAO,EAAE,OAAO,EAAE,QAAQ,EAAE;AAC/C,cAAQ,CAAC,OAAO,GAAG,IAAI,OAAO,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;AACjD,aAAO,QAAQ,CAAC;KACjB;;;WAEmB,uBAAC,OAAO,EAAE,OAAO,EAAE,QAAQ,EAAE;;;wBAEhB,GAAG,CAAC,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC;;UAA7C,QAAQ,eAAR,QAAQ;UAAE,QAAQ,eAAR,QAAQ;;AAC1B,UAAM,UAAU,GAAG,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC;AACzD,aAAO,CAAC,OAAO,CAAC,MAAM,CAAC,UAAU,EAAE,QAAQ,EAAE,QAAQ,CAAC,CAAC;AACvD,aAAO,QAAQ,CAAC;KACjB;;;WAE0B,wBAAC,OAAO,EAAE,OAAO,EAAE,QAAQ;UAC5C,MAAM,EAKN,SAAQ;;;;;AALR,kBAAM,GAAM,QAAQ,CAApB,MAAM;;kBACV,MAAM,KAAK,GAAG,IAAI,MAAM,KAAK,GAAG,IAAI,MAAM,KAAK,GAAG,IAAI,MAAM,KAAK,GAAG,IAAI,MAAM,KAAK,GAAG,CAAA;;;;;kBACpF,OAAO,CAAC,QAAQ,KAAK,OAAO,CAAA;;;;;gDACvB,KAAK,CAAC,QAAQ,CAAC,KAAK,EAAE;;;AAEzB,qBAAQ,GAAG,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,UAAU,CAAC;;kBAC7C,SAAQ,KAAK,IAAI,CAAA;;;;;gDACZ,QAAQ;;;kBAEb,OAAO,CAAC,cAAc,IAAI,EAAE,CAAA;;;;;gDACvB,KAAK,CAAC,QAAQ,CAAC,KAAK,EAAE;;;;AAE/B,mBAAO,CAAC,IAAI,CAAC,UAAU,EAAE,OAAO,EAAE,QAAQ,EAAE,SAAQ,CAAC,CAAC;AACtD,cAAE,OAAO,CAAC,cAAc,CAAC;AACzB,gBAAI,MAAM,KAAK,GAAG,EAAE;AAClB,qBAAO,CAAC,MAAM,GAAG,KAAK,CAAC;AACvB,qBAAO,CAAC,OAAO,UAAO,CAAC,cAAc,CAAC,CAAC;AACvC,qBAAO,CAAC,OAAO,UAAO,CAAC,gBAAgB,CAAC,CAAC;AACzC,qBAAO,CAAC,OAAO,UAAO,CAAC,2BAA2B,CAAC,CAAC;aACrD;;;AAGD,mBAAO,CAAC,OAAO,CAAC,GAAG,CAAC,SAAS,EAAE,OAAO,CAAC,GAAG,CAAC,CAAC;AAC5C,mBAAO,CAAC,GAAG,GAAG,KAAK,CAAC,WAAW,CAAC,OAAO,CAAC,GAAG,EAAE,SAAQ,CAAC,CAAC;;mBAC1C,OAAO,CAAC,QAAQ,CAAC,YAAY,CAAC,OAAO,CAAC;;;;;;gDAE5C,QAAQ;;;;;;;KAClB;;;SAnOG,QAAQ;GAAS,KAAK;;;;AA0O5B,QAAQ,CAAC,QAAQ,GAAG,CAClB,QAAQ,CAAC,YAAY,EACrB,QAAQ,CAAC,YAAY,EACrB,QAAQ,CAAC,aAAa,EACtB,QAAQ,CAAC,aAAa,EACtB,QAAQ,CAAC,cAAc,CACxB,CAAC;;AAEF,MAAM,CAAC,OAAO,GAAG,QAAQ,CAAC","file":"pipeline.js","sourcesContent":["const _               = require('lodash');\nconst assert          = require('assert');\nconst Fetch           = require('./fetch');\nconst File            = require('fs');\nconst { Headers }     = require('./fetch');\nconst { isArray }     = require('util');\nconst Path            = require('path');\nconst Request         = require('request');\nconst resourceLoader  = require('jsdom/lib/jsdom/browser/resource-loader');\nconst URL             = require('url');\nconst Utils           = require('jsdom/lib/jsdom/utils');\n\n\n// Pipeline is sequence of request/response handlers that are used to prepare a\n// request, make the request, and process the response.\nclass Pipeline extends Array {\n\n  constructor(browser) {\n    super();\n    this._browser = browser;\n    for (let handler of Pipeline._default)\n      this.push(handler);\n  }\n\n  async _fetch(input, init) {\n    const request   = new Fetch.Request(input, init);\n    const browser   = this._browser;\n    browser.emit('request', request);\n\n    try {\n\n      const response    = await this._runPipeline(request);\n      response.time     = Date.now();\n      response.request  = request;\n      browser.emit('response', request, response);\n      return response;\n\n    } catch (error) {\n      browser._debug('Resource error', error.stack);\n      throw new TypeError(error.message);\n    }\n  }\n\n  async _runPipeline(request) {\n    const browser           = this._browser;\n    const requestHandlers   = this.filter(fn => fn.length === 2).concat(Pipeline.makeHTTPRequest);\n    const responseHandlers  = this.filter(fn => fn.length === 3);\n\n    let response;\n    for (let requestHandler of requestHandlers) {\n      response = await requestHandler(browser, request);\n      if (response)\n        break;\n    }\n    for (let responseHandler of responseHandlers) {\n      response = await responseHandler(browser, request, response);\n      assert(response, 'Response handler must return a response');\n    }\n    return response;\n  }\n\n\n  // -- Handlers --\n\n  // Add a request or response handler.  This handler will only be used by this\n  // pipeline instance (browser).\n  addHandler(handler) {\n    assert(handler.call, 'Handler must be a function');\n    assert(handler.length === 2 || handler.length === 3, 'Handler function takes 2 (request handler) or 3 (reponse handler) arguments');\n    this.push(handler);\n  }\n\n  // Add a request or response handler.  This handler will be used by any new\n  // pipeline instance (browser).\n  static addHandler(handler) {\n    assert(handler.call, 'Handler must be a function');\n    assert(handler.length === 2 || handler.length === 3, 'Handler function takes 2 (request handler) or 3 (response handler) arguments');\n    this._default.push(handler);\n  }\n\n\n  // -- Prepare request --\n\n  // This handler normalizes the request URL.\n  //\n  // It turns relative URLs into absolute URLs based on the current document URL\n  // or base element, or if no document open, based on browser.site property.\n  static normalizeURL(browser, request) {\n    if (browser.document)\n    // Resolve URL relative to document URL/base, or for new browser, using\n    // Browser.site\n      request.url = resourceLoader.resolveResourceUrl(browser.document, request.url);\n    else\n      request.url = Utils.resolveHref(browser.site || 'http://localhost', request.url);\n  }\n\n\n  // This handler mergers request headers.\n  //\n  // It combines headers provided in the request with custom headers defined by\n  // the browser (user agent, authentication, etc).\n  //\n  // It also normalizes all headers by down-casing the header names.\n  static mergeHeaders(browser, request) {\n    if (browser.headers)\n      _.each(browser.headers, (value, name)=> {\n        request.headers.append(name, browser.headers[name]);\n      });\n    if (!request.headers.has('User-Agent'))\n      request.headers.set('User-Agent', browser.userAgent);\n\n    // Always pass Host: from request URL\n    const { host } = URL.parse(request.url);\n    request.headers.set('Host', host);\n\n    // HTTP Basic authentication\n    const authenticate = { host, username: null, password: null };\n    browser.emit('authenticate', authenticate);\n    const { username, password } = authenticate;\n    if (username && password) {\n      browser.log(`Authenticating as ${username}:${password}`);\n      const base64 = new Buffer(`${username}:${password}`).toString('base64');\n      request.headers.set('authorization',  `Basic ${base64}`);\n    }\n  }\n\n\n  // -- Retrieve actualy resource --\n\n  // Used to perform HTTP request (also supports file: resources).  This is always\n  // the last request handler.\n  static async makeHTTPRequest(browser, request) {\n    const { url } = request;\n    const { protocol, hostname, pathname } = URL.parse(url);\n\n    if (protocol === 'file:') {\n\n      // If the request is for a file:// descriptor, just open directly from the\n      // file system rather than getting node's http (which handles file://\n      // poorly) involved.\n      if (request.method !== 'GET')\n        return new Fetch.Response('', { url, status: 405 });\n\n      const filename = Path.normalize(decodeURI(pathname));\n      const exists   = File.existsSync(filename);\n      if (exists) {\n        const stream = File.createReadStream(filename);\n        return new Fetch.Response(stream, { url, status: 200 });\n      } else\n        return new Fetch.Response('', { url, status: 404 });\n\n    } else {\n\n      // We're going to use cookies later when recieving response.\n      const { cookies }   = browser;\n      const cookieHeader  = cookies.serialize(hostname, pathname);\n      if (cookieHeader)\n        request.headers.append('Cookie', cookieHeader);\n\n      const buffer      = /^GET|HEAD$/.test(request.method) ? null : await request._consume();\n      const httpRequest = new Request({\n        method:         request.method,\n        uri:            request.url,\n        headers:        request.headers.toObject(),\n        proxy:          browser.proxy,\n        body:           buffer,\n        jar:            false,\n        followRedirect: false,\n        strictSSL:      browser.strictSSL,\n        localAddress:   browser.localAddress || 0\n      });\n      return await new Promise(function(resolve, reject) {\n        httpRequest\n          .on('response', (response)=> {\n            // Request returns an object where property name is header name,\n            // property value is either header value, or an array if header sent\n            // multiple times (e.g. `Set-Cookie`).\n            const arrayOfHeaders = _.reduce(response.headers, (headers, value, name)=> {\n              if (isArray(value))\n                for (let item of value)\n                  headers.push([name, item]);\n              else\n                headers.push([name, value]);\n              return headers;\n            }, []);\n\n            resolve(new Fetch.Response(response, {\n              url:        request.url,\n              status:     response.statusCode,\n              headers:    new Headers(arrayOfHeaders)\n            }));\n          })\n          .on('error', reject);\n      });\n    }\n\n  }\n\n\n  // -- Handle response --\n\n  static handleHeaders(browser, request, response) {\n    response.headers = new Headers(response.headers);\n    return response;\n  }\n\n  static handleCookies(browser, request, response) {\n    // Set cookies from response: call update() with array of headers\n    const { hostname, pathname } = URL.parse(request.url);\n    const newCookies = response.headers.getAll('Set-Cookie');\n    browser.cookies.update(newCookies, hostname, pathname);\n    return response;\n  }\n\n  static async handleRedirect(browser, request, response) {\n    const { status }  = response;\n    if (status === 301 || status === 302 || status === 303 || status === 307 || status === 308) {\n      if (request.redirect === 'error')\n        return Fetch.Response.error();\n\n      const location = response.headers.get('Location');\n      if (location === null)\n        return response;\n\n      if (request._redirectCount >= 20)\n        return Fetch.Response.error();\n\n      browser.emit('redirect', request, response, location);\n      ++request._redirectCount;\n      if (status !== 307) {\n        request.method = 'GET';\n        request.headers.delete('Content-Type');\n        request.headers.delete('Content-Length');\n        request.headers.delete('Content-Transfer-Encoding');\n      }\n\n      // This request is referer for next\n      request.headers.set('Referer', request.url);\n      request.url = Utils.resolveHref(request.url, location);\n      return await browser.pipeline._runPipeline(request);\n    } else\n      return response;\n  }\n\n}\n\n\n// The default pipeline.  All new pipelines are instantiated with this set of\n// handlers.\nPipeline._default = [\n  Pipeline.normalizeURL,\n  Pipeline.mergeHeaders,\n  Pipeline.handleHeaders,\n  Pipeline.handleCookies,\n  Pipeline.handleRedirect\n];\n\nmodule.exports = Pipeline;\n\n"],"sourceRoot":"/source/"}