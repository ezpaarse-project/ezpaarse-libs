'use strict';

var clone = require('clone')
  , CSV = require('csv-string')
  ;

module.exports = function(options) {

  options = options || {};
  options.encoding = options.encoding ? options.encoding : 'utf8';
  options.separator = options.separator ? options.separator : undefined;

  return function (input, submit) {

    var columns = [] , numb = 0;
    var readable = input.openStream({
        encoding: options.encoding
      });
    var parser = CSV.createStream({
      separator : options.separator
    });

    parser.on('data', function (row) {
      if (columns.length === 0) {
        columns = row;
      }
      else {
        var doc = clone(input, false);
        doc.content = {};
        doc.content.json = {};
        columns.forEach(function(x, i) {
          doc.content.json[x] = row[i];
        });
        ++numb;
        submit(doc);
      }
    });
    parser.on('end', function() {
      if (numb > 0) {
        submit();
      } else {
        submit(new Error('No line detected !'));
      }
    });
    parser.on('error', function(e) {
      submit(e);
    });

    readable.pipe(parser);
  }
}
